---
import { cvData } from '../data/cv-data';
import { getLangFromUrl, useTranslations, resolve } from '../i18n/utils';
import { getRelativeLocaleUrl } from 'astro:i18n';
import LanguageSwitcher from './LanguageSwitcher.astro';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const initials = cvData.personal.name.split(' ').map(n => n[0]).join('');
const homeHref = getRelativeLocaleUrl(lang, '');

const aboutText = resolve(cvData.about.text, lang);

const sections = [
  { id: 'about', label: t('nav.about') },
  { id: 'experience', label: t('nav.experience') },
  { id: 'education', label: t('nav.education') },
  { id: 'skills', label: t('nav.skills') },
  { id: 'languages', label: t('nav.languages') },
  { id: 'portfolio', label: t('nav.projects') },
  { id: 'contact', label: t('nav.contact') },
].filter(s => {
  if (s.id === 'about') return typeof aboutText === 'string' && aboutText.trim().length > 0;
  if (s.id === 'experience') return cvData.experience.length > 0;
  if (s.id === 'education') return cvData.education.length > 0;
  if (s.id === 'skills') return cvData.skills.length > 0;
  if (s.id === 'languages') return (cvData.languages as readonly unknown[]).length > 0;
  if (s.id === 'portfolio') return cvData.projects.length > 0;
  return true;
});

const sectionHref = (id: string) => `${homeHref}#${id}`;
---
<nav class="fixed top-0 left-0 right-0 z-50 glass border-b" aria-label="Main navigation">
  <div class="mx-auto max-w-5xl px-6 flex items-center justify-between h-16">
    <a href={homeHref} class="font-bold tracking-tight text-xl gradient-text" aria-label={t('a11y.goHome')}>
      {initials}
    </a>

    <div class="hidden md:flex items-center justify-center gap-1 flex-1">
      {sections.map(s => (
        <a
          href={sectionHref(s.id)}
          class="nav-link link-animated text-sm px-3 py-2 rounded-lg transition-colors hover:bg-[var(--accent-glow)] text-center whitespace-nowrap min-w-[5.5rem]"
          style="color: var(--text-muted);"
          data-section={s.id}
        >
          {s.label}
        </a>
      ))}
    </div>

    <div class="flex items-center gap-2">
      <LanguageSwitcher />
      <button id="theme-toggle" aria-label={t('a11y.switchToDark')} data-label-dark={t('a11y.switchToDark')} data-label-light={t('a11y.switchToLight')} class="btn-icon min-h-[44px] min-w-[44px] flex items-center justify-center rounded-lg" style="color: var(--text-muted);">
        <svg class="w-[18px] h-[18px] dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
        </svg>
        <svg class="w-[18px] h-[18px] hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="12" cy="12" r="5" /><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
        </svg>
      </button>
      <button id="mobile-menu-toggle" class="md:hidden min-h-[44px] min-w-[44px] flex items-center justify-center rounded-lg" style="color: var(--text-muted);" aria-label={t('a11y.openMenu')} aria-expanded="false" aria-controls="mobile-menu">
        <svg class="hamburger-icon w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M4 6h16M4 12h16M4 18h16" />
        </svg>
        <svg class="close-icon w-5 h-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>

  <div id="mobile-menu" class="hidden md:hidden border-t pb-4 px-6" style={`border-color: var(--border); background: var(--bg);`}>
    {sections.map(s => (
      <a href={sectionHref(s.id)} class="block min-h-[44px] flex items-center text-sm transition-colors mobile-nav-link" style="color: var(--text-muted);">
        {s.label}
      </a>
    ))}
  </div>
</nav>

<script>
  document.addEventListener('DOMContentLoaded', () => {

    const toggle = document.getElementById('mobile-menu-toggle');
    const menu = document.getElementById('mobile-menu');
    if (toggle && menu) {
      toggle.addEventListener('click', () => {
        const isHidden = menu.classList.toggle('hidden');
        toggle.setAttribute('aria-expanded', isHidden ? 'false' : 'true');
        toggle.querySelector('.hamburger-icon')?.classList.toggle('hidden', !isHidden);
        toggle.querySelector('.close-icon')?.classList.toggle('hidden', isHidden);
      });
    }
    document.querySelectorAll('.mobile-nav-link').forEach((link) => {
      link.addEventListener('click', () => {
        if (menu) menu.classList.add('hidden');
        if (toggle) {
          toggle.setAttribute('aria-expanded', 'false');
          toggle.querySelector('.hamburger-icon')?.classList.remove('hidden');
          toggle.querySelector('.close-icon')?.classList.add('hidden');
        }
      });
    });

    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('section[id]');
    if (window.__navObserver) window.__navObserver.disconnect();
    window.__navObserver = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          navLinks.forEach((link) => {
            const isActive = link.getAttribute('data-section') === entry.target.id;
            (link as HTMLElement).style.color = isActive ? 'var(--accent)' : 'var(--text-muted)';
            (link as HTMLElement).style.fontWeight = isActive ? '500' : '400';
            if (isActive) link.setAttribute('aria-current', 'true');
            else link.removeAttribute('aria-current');
          });
        }
      });
    }, { rootMargin: '-20% 0px -70% 0px' });
    sections.forEach((section) => window.__navObserver?.observe(section));

    const nav = document.querySelector('nav');
    const handleNavScroll = () => {
      if (!nav) return;
      nav.setAttribute('data-scrolled', String(window.scrollY > 20));
    };
    window.addEventListener('scroll', handleNavScroll, { passive: true });
    handleNavScroll();
  });
</script>
